from pathlib import Path

import geopandas as gpd
import pytest
from pyprojroot import here

from hydrofabric_builds.hydrofabric.waterbodies import crosswalk_waterbodies


@pytest.fixture
def rfcda_path() -> Path:
    return here() / "tests/data/waterbodies/sample_rfcda.gpkg"


@pytest.fixture
def hf_path() -> Path:
    """Creates a temp HF for the tests. We want to make this every time so that the waterbody layer is not present"""
    path = here() / "tests/data/waterbodies/sample_hf_wb.gpkg"
    fp_id = [
        1332536,
        1332606,
        1332679,
        1332680,
        1332756,
        1332757,
        1332842,
        1332927,
        1333008,
        1333082,
        1333152,
    ]
    ref_fp_id = [
        7047639,
        7047429,
        7047421,
        7047671,
        7051285,
        7049011,
        7048127,
        7048073,
        7048009,
        7047983,
        7048917,
    ]
    gdf = gpd.GeoDataFrame(
        data={"fp_id": fp_id, "ref_fp_id": ref_fp_id},
        geometry=gpd.GeoSeries.from_wkt(
            [
                "MULTILINESTRING ((-2730.227444 2815801.806127, -2716.097351 2815785.097504, -2269.281539 2815320.249924, -2269.283148 2814564.250763, -2353.288583 2814382.244913, -2353.27777 2813962.246986, -2983.289261 2813332.258046, -3137.290341 2813234.254861, -3389.291385 2813122.253962, -3725.28923 2813038.251682, -3865.288838 2813024.250224, -4075.282711 2812814.25263, -4173.289082 2812758.254089, -4313.291589 2812618.250129, -4313.071073 2812570.249437, -4315.862379 2812560.91829, -4317.468832 2812554.398758, -4312.407269 2812504.082001, -4304.736812 2812491.491578))",
                "MULTILINESTRING ((-2216.797243 2816158.134189, -2380.956921 2816130.742924, -2593.800698 2816108.446323, -2670.762702 2816093.475116, -2686.171676 2816078.407802, -2704.176133 2816048.246341, -2719.607935 2816013.069314, -2722.359744 2815902.396624, -2737.804986 2815872.248765, -2735.317474 2815826.976685, -2730.227444 2815801.806127))",
                "MULTILINESTRING ((-2214.182448 2816190.84186, -2216.797243 2816158.134189))",
                "MULTILINESTRING ((-186.13326 2818974.157265, -191.265675 2818971.661379, -211.917177 2818891.209172, -232.538231 2818840.951481, -268.522198 2818788.190944, -353.299683 2818702.829996, -396.991318 2818655.12107, -407.277578 2818635.013754, -420.096738 2818632.525789, -443.253281 2818592.318696, -474.138007 2818529.508099, -556.436325 2818388.801903, -564.175085 2818361.162148, -579.589444 2818348.609588, -620.737573 2818280.771054, -638.72158 2818263.197274, -651.593677 2818235.557954, -659.333208 2818205.385355, -705.521597 2818182.822184, -718.372877 2818167.751473, -733.840406 2818130.047328, -739.000393 2818109.946931, -798.024899 2818084.889529, -992.918845 2818085.222414, -1026.305085 2818055.097729, -1054.585383 2818012.389093, -1157.299209 2817932.066995, -1229.209249 2817864.287441, -1239.508983 2817844.180766, -1252.329859 2817841.694231, -1478.487605 2817557.860991, -1488.745416 2817552.856152, -1496.488181 2817527.727425, -1535.066715 2817454.840614, -1601.862235 2817384.529703, -1640.452602 2817311.650437, -1655.908683 2817266.399893, -1666.245725 2817223.666311, -1720.341066 2817077.880018, -1743.559799 2816997.442148, -1743.736606 2816886.772318, -1754.039831 2816864.147457, -1779.731697 2816834.008424, -1841.331235 2816803.930049, -1859.32331 2816781.321952, -1964.922191 2816504.819559, -1977.831674 2816444.487453, -1978.164248 2816253.333142, -2001.301005 2816218.156961, -2050.081305 2816177.995616, -2098.825536 2816160.4772, -2188.5979 2816150.555877, -2216.797243 2816158.134189))",
                "MULTILINESTRING ((-961.843952 2817621.029382, -585.394439 2817636.088304, -273.386816 2817192.707293, -306.230945 2816338.789146, -22.022822 2815750.768712))",
                "MULTILINESTRING ((2252.814545 2825249.052217, 2255.515327 2825171.106437, 2168.549692 2825027.648169, 2140.462262 2824947.138188, 2148.370005 2824818.923461, 2107.423441 2824755.995124, 2110.151463 2824665.482269, 2166.832357 2824514.711076, 2159.223166 2824461.898914, 2136.23736 2824396.479549, 2105.776837 2824207.865756, 2072.500965 2824165.057148, 2005.85123 2824139.803491, 1926.351548 2824134.650908, 1752.142765 2824013.673511, 1516.504341 2823812.130376, 1391.062876 2823666.090202, 1355.193902 2823645.912906, 891.105949 2823549.597055, 855.244936 2823529.4222, 745.176577 2823390.946772, 668.397956 2823292.750637, 481.734258 2822963.045146, 425.537576 2822827.174166, 415.407479 2822751.723204, 425.862933 2822638.588271, 459.509335 2822457.578403, 451.992814 2822359.510935, 444.342064 2822331.829955, 470.1582 2822226.262311, 524.281107 2822075.472037, 529.520783 2822010.105815, 223.965573 2820722.08304, 7.713083 2819705.751454, -21.891008 2819665.471109, -41.371307 2819627.782162, -72.408424 2819481.973676, -103.426791 2819341.200596, -121.472233 2819290.93601, -116.380426 2819265.785102, -180.935047 2819014.394449, -186.13326 2818974.157265))",
                "MULTILINESTRING ((3073.680023 2826801.663768, 3102.048403 2826711.205768, 3050.894412 2826620.617571, 3053.547788 2826567.82019, 3089.572182 2826494.964252, 3074.246526 2826459.743761, 3053.771663 2826429.533777, 3051.261752 2826391.816075, 3017.953398 2826369.138085, 2951.307769 2826343.884882, 2912.883 2826306.108245, 2835.909419 2826313.533842, 2810.316017 2826283.315021, 2794.983534 2826248.102203, 2753.993425 2826217.855454, 2707.839221 2826205.206696, 2713.015809 2826180.078738, 2749.036725 2826112.254867, 2736.240885 2826087.090551, 2700.354233 2826076.970493, 2654.314072 2825996.447363, 2546.654309 2825945.986215, 2508.310088 2825865.473757, 2464.949948 2825719.572234, 2431.881695 2825548.543227, 2247.603649 2825306.871858, 2252.814545 2825249.052217))",
                "MULTILINESTRING ((3620.125047 2828363.818461, 3610.033477 2828255.698242, 3607.549778 2828202.901558, 3571.726433 2828150.058571, 3458.951328 2828087.020796, 3443.616008 2828051.786838, 3459.038048 2828031.707867, 3579.687916 2827989.150841, 3592.552696 2827953.974742, 3590.051172 2827916.258917, 3613.173958 2827898.693984, 3669.632744 2827881.182959, 3690.205573 2827853.562629, 3692.797489 2827841.007094, 3644.07767 2827823.324489, 3564.570564 2827818.176245, 3510.696911 2827815.573444, 3436.225281 2827863.232631, 3413.147356 2827860.682239, 3408.106547 2827807.868969, 3459.475495 2827767.727848, 3544.204073 2827722.59845, 3610.892275 2827722.712775, 3687.835971 2827735.411997, 3710.942015 2827722.874438, 3718.681589 2827697.742583, 3680.229216 2827677.569777, 3600.726879 2827659.849463, 3528.993043 2827606.936171, 3521.354955 2827569.210011, 3526.548395 2827534.014783, 3598.476092 2827471.280358, 3601.079341 2827446.152886, 3588.291372 2827426.008135, 3560.095858 2827413.392836, 3539.624585 2827375.652632, 3549.935811 2827348.004269, 3598.701875 2827330.48115, 3608.990907 2827307.874748, 3598.768372 2827287.738522, 3560.282167 2827290.192387, 3470.453077 2827322.733332, 3447.363441 2827320.190113, 3437.140461 2827300.061468, 3452.592604 2827262.368196, 3468.010178 2827244.791295, 3457.783392 2827222.14526, 3406.493199 2827214.531864, 3383.440269 2827196.899705, 3434.825777 2827141.661005, 3437.432338 2827119.035811, 3409.263717 2827088.814457, 3360.496462 2827106.339029, 3306.571051 2827138.943377, 3268.091437 2827136.371558, 3242.486742 2827108.676718, 3229.718945 2827073.465175, 3278.600982 2826990.555418, 3265.802463 2826967.908266, 3111.973533 2826914.887209, 3104.314825 2826894.759875, 3148.011718 2826842.025142, 3078.786324 2826814.238008, 3073.680023 2826801.663768))",
                "MULTILINESTRING ((3389.069894 2830035.251499, 3412.25321 2829979.982867, 3394.353263 2829942.255139, 3320.105011 2829849.118094, 3304.792436 2829803.833077, 3310.000162 2829753.574778, 3392.356517 2829597.833445, 3410.508934 2829474.687978, 3395.262589 2829384.152985, 3369.737574 2829301.156853, 3387.841287 2829218.210604, 3459.861105 2829102.692259, 3475.454655 2828982.045981, 3478.095373 2828929.260572, 3432.010623 2828873.868141, 3370.522134 2828823.50289, 3350.104454 2828763.125376, 3329.683796 2828697.735465, 3298.998555 2828639.855517, 3304.207094 2828589.580429, 3324.80579 2828541.851645, 3335.243115 2828431.246975, 3407.221913 2828343.377348, 3468.830841 2828318.330546, 3491.924677 2828315.846677, 3522.567381 2828408.924855, 3545.614776 2828429.066553, 3594.380829 2828416.563804, 3607.220892 2828409.055421, 3620.125047 2828363.818461))",
                "MULTILINESTRING ((3511.67941 2831930.863148, 3386.102229 2831840.17239, 3370.784416 2831794.905156, 3370.929357 2831699.38801, 3378.825984 2831583.753637, 3412.368147 2831470.706695, 3492.042057 2831387.870453, 3497.259925 2831337.593154, 3461.451446 2831264.643212, 3446.104411 2831236.964094, 3446.187347 2831189.208274, 3477.047751 2831138.972449, 3536.149371 2831091.311661, 3559.322891 2831041.072189, 3574.828914 2830960.654623, 3654.570985 2830837.598484, 3662.368641 2830779.807382, 3644.459511 2830747.09206, 3503.536113 2830636.258887, 3490.852966 2830545.736081, 3508.880267 2830503.02927, 3552.651552 2830412.600093, 3537.357928 2830344.699014, 3478.48843 2830261.644793, 3432.487662 2830153.470681, 3365.884559 2830095.539507, 3389.069894 2830035.251499))",
                "MULTILINESTRING ((4898.716701 2831686.255371, 4842.711924 2831742.24908, 4758.716004 2831756.251647, 4688.717753 2831812.251735, 4409.708943 2831824.180368, 4379.057025 2831829.187824, 4248.089975 2831891.839528, 4158.249155 2831919.347251, 4037.572909 2831979.469783, 3886.137903 2832009.404255, 3739.929596 2831986.541781, 3624.543109 2831943.621679, 3511.67941 2831930.863148))",
            ]
        ),
    )
    gdf.to_file(path, layer="flowpaths")

    gpd.GeoDataFrame(gdf[["fp_id", "ref_fp_id"]]).to_file(path, layer="reference_flowpaths")

    return path


@pytest.fixture
def expected_wb() -> dict[str, list[int]]:
    fp_id = [1332679, 1333152]
    ref_fp_id = [7047421, 7048917]
    return {"fp_id": fp_id, "ref_fp_id": ref_fp_id}


def test_crosswalk_wb(rfcda_path: Path, hf_path: Path, expected_wb: dict[str, list[int]]) -> None:
    """Reservoir crosswalk

    This test includes an RFC-DA dataset with 3 points. 2 points are matched from ref_fp_id to fp_id
    Delete the HF created at the end"""
    try:
        output = crosswalk_waterbodies(hf_path, rfcda_path)

        assert output["wb_id"].tolist() == [1, 2]
        assert output["fp_id"].tolist() == expected_wb["fp_id"]
        assert output["ref_fp_id"].tolist() == expected_wb["ref_fp_id"]

    finally:
        hf_path.unlink(missing_ok=True)
