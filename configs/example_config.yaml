# main

# output_name: "nhf.gpkg" # If not specified, will default to version
output_dir: "data/"
crs: "EPSG:5070"

# build hf
build:
  reference_divides_path: data/reference/reference_divides.parquet
  reference_flowpaths_path: data/reference/reference_flowpaths.parquet
  # debug_outlet_count: 2000 # If specified, only the total amount of rivers here will be built
  divide_aggregation_threshold: 3.0

# choose tasks to run
tasks:
  build_hydrofabric: True
  divide_attributes: True
  flowpath_attributes: True
  waterbodies: True
  hydrolocations: True
  gages: True
  fp_crosswalk: True


# flowpaths
flowpath_attributes:
  flowpath_id: fp_id
  use_stream_order: True
  dem_path: data/divide-attributes/usgs/usgs_250m_dem_5070.tif
  tw_path: data/flowpath-attributes/TW_bf_predictions.parquet
  y_path: data/flowpath-attributes/Y_bf_predictions.parquet
  r_path: data/flowpath-attributes/r_predictions.parquet

# divide attributes
divide_attributes:
  processes: 10
  data_dir: data/divide-attributes
  divide_id: div_id
  tmp_dir: data/tmp/divide-attributes
  split_vpu: True
  debug: False
  attributes: # attributes must be specified - there are no defaults
    bexp1:
      file_name: 'nwm/bexp_0.tif'
      agg_type: 'mode'
      field_name: 'bexp_mode'
    isltyp:
      file_name: 'nwm/ISLTYP.tif'
      agg_type: 'mode'
      field_name: 'isltyp_mode'
    ivgtyp:
      file_name: 'nwm/IVGTYP.tif'
      agg_type: 'mode'
      field_name: 'ivgtyp_mode'
    dksat:
      file_name: 'nwm/dksat_0.tif'
      agg_type: 'weighted_geometric_mean'
      field_name: 'dksat_geomean'
    psisat:
      file_name: 'nwm/psisat_0.tif'
      agg_type: 'weighted_geometric_mean'
      field_name: 'psisat_geomean'
    cwpvt:
      file_name: 'nwm/cwpvt.tif'
      agg_type: 'mean'
      field_name: 'cwpvt_mean'
    mp:
      file_name: 'nwm/mp.tif'
      agg_type: 'mean'
      field_name: 'mp_mean'
    mfsno:
      file_name: 'nwm/mfsno.tif'
      agg_type: 'mean'
      field_name: 'mfsno_mean'
    quartz:
      file_name: 'nwm/quartz_0.tif'
      agg_type: 'mean'
      field_name: 'quartz_mean'
    refkdt:
      file_name: 'nwm/refkdt.tif'
      agg_type: 'mean'
      field_name: 'refkdt_mean'
    slope_1km:
      file_name: 'nwm/slope.tif'
      agg_type: 'mean'
      field_name: 'slope1km_mean'
    smcmax:
      file_name: 'nwm/smcmax_0.tif'
      agg_type: 'mean'
      field_name: 'smcmax_mean'
    smcwlt:
      file_name: 'nwm/smcwlt_0.tif'
      agg_type: 'mean'
      field_name: 'smcwlt_mean'
    vcmx:
      file_name: 'nwm/vcmx25.tif'
      agg_type: 'mean'
      field_name: 'vcmx_mean'
    impervious:
      file_name: 'nwm/imperv.tif'
      agg_type: 'mean'
      field_name: 'imperv_mean'
    twi:
      file_name: 'twi/twi.tif'
      agg_type: 'quartile_dist'
      field_name: 'twi_quartile'
    twi_2:                      # another twi option
      file_name: 'twi/twi.tif'
      agg_type: 'quantile_dist'
      field_name: 'twi_quantile'
    elevation:
      file_name: 'usgs/usgs_250m_dem_5070.tif'
      agg_type: 'mean'
      field_name: 'elevation_mean'
    slope:
      file_name: 'usgs/usgs_250m_slope_5070.tif'
      agg_type: 'mean'
      field_name: 'slope250m_mean'
    aspect:
      file_name: 'usgs/usgs_250m_aspect_5070.tif'
      agg_type: 'weighted_circular_mean'
      field_name: 'aspect_circmean'
    glaciers:
      file_name: 'glaciers/glims_20250624.parquet' # must include 'glacier' or 'glims' to be used
      agg_type: 'percent'
      field_name: 'glacier_percent'
    groundwater:
      file_name: 'gw/gw.csv' # must include 'gw' or 'groundwater' to be used
      agg_type: 'groundwater'
      field_name: 'groundwater' # field name not honored, all fields in csv will be joined
    lzfpm:
      file_name: 'sac-sma/LZFPM.tif'
      agg_type: 'mean'
      field_name: 'lzfpm_mean'
    lzpk:
      file_name: 'sac-sma/LZPK.tif'
      agg_type: 'mean'
      field_name: 'lzpk_mean'
    lztwm:
      file_name: 'sac-sma/LZTWM.tif'
      agg_type: 'mean'
      field_name: 'lztwm_mean'
    rexp:
      file_name: 'sac-sma/REXP.tif'
      agg_type: 'mean'
      field_name: 'rexp_mean'
    uzk:
      file_name: 'sac-sma/UZK.tif'
      agg_type: 'mean'
      field_name: 'uzk_mean'
    zperc:
      file_name: 'sac-sma/ZPERC.tif'
      agg_type: 'mean'
      field_name: 'zperc_mean'
    lzfsm:
      file_name: 'sac-sma/LZFSM.tif'
      agg_type: 'mean'
      field_name: 'lzfsm_mean'
    lzsk:
      file_name: 'sac-sma/LZSK.tif'
      agg_type: 'mean'
      field_name: 'lzsk_mean'
    pfree:
      file_name: 'sac-sma/PFREE.tif'
      agg_type: 'mean'
      field_name: 'pfree_mean'
    uzfwm:
      file_name: 'sac-sma/UZFWM.tif'
      agg_type: 'mean'
      field_name: 'uzfwm_mean'
    uztwm:
      file_name: 'sac-sma/UZTWM.tif'
      agg_type: 'mean'
      field_name: 'uztwm_mean'
    mfmin:
      file_name: 'snow17/MFMIN.tif'
      agg_type: 'mean'
      field_name: 'mfmin_mean'
    mfmax:
      file_name: 'snow17/MFMAX.tif'
      agg_type: 'mean'
      field_name: 'mfmax_mean'
    uadj:
      file_name: 'snow17/UADJ.tif'
      agg_type: 'mean'
      field_name: 'uadj_mean'
    axaj:
      file_name: 'nwm/AXAJ.tif'
      agg_type: 'mean'
      field_name: 'a_xinanjiang_inflection_point_parameter'
    bxaj:
      file_name: 'nwm/BXAJ.tif'
      agg_type: 'mean'
      field_name: 'b_xinanjiang_shape_parameter'
    xxaj:
      file_name: 'nwm/XXAJ.tif'
      agg_type: 'mean'
      field_name: 'x_xinanjiang_shape_parameter'
    temp_delta_jan:
      file_name: 'ueb/jan.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_jan_mean'
    temp_delta_feb:
      file_name: 'ueb/feb.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_feb_mean'
    temp_delta_mar:
      file_name: 'ueb/mar.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_mar_mean'
    temp_delta_apr:
      file_name: 'ueb/apr.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_apr_mean'
    temp_delta_may:
      file_name: 'ueb/may.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_may_mean'
    temp_delta_jun:
      file_name: 'ueb/jun.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_jun_mean'
    temp_delta_jul:
      file_name: 'ueb/jul.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_jul_mean'
    temp_delta_aug:
      file_name: 'ueb/aug.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_aug_mean'
    temp_delta_sep:
      file_name: 'ueb/sep.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_sep_mean'
    temp_delta_oct:
      file_name: 'ueb/oct.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_oct_mean'
    temp_delta_nov:
      file_name: 'ueb/nov.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_nov_mean'
    temp_delta_dec:
      file_name: 'ueb/dec.tif'
      agg_type: 'mean'
      field_name: 'temp_delta_dec_mean'

# waterbodies - all values have defaults
waterbodies:
  input_dir: "data/reservoirs"
  output_dir: "data/reservoirs/output"
  rfcda_output_name: "rfc-da-hydraulics-v1.gpkg"
  rfcda_file: "data/reservoirs/output/rfc-da-hydraulics-v1.gpkg" # Note: By default this concatenates output_dir and rfcda_output_name but can be specified
  default_src_crs: "EPSG:4326"
  work_crs: "EPSG:5070"
  nid:
    path: "source_files/NID2019_U.csv"
    src_crs: "EPGS:4326"
    output_crs: "EPSG:5070"
    drop_states: ["AK", "HI", "PR", "GU"]
  refwb:
    path: "reference_reservoirs/reference_waterbodies.gpkg"
    layer: "reference_waterbodies"
    src_crs: null
    output_crs: "EPSG:5070"
    id_col: "comid"
  refres:
    path: "reference_reservoirs/reference-reservoirs-v1.gpkg"
    layer: "reference-reservoirs-v1"
    src_crs: null
    output_crs: "EPSG:5070"
    distance_to_fp_col: "distance_to_fp_m"
    wb_area_col: "wb_areasqkm"
    ref_wb_id_col: "ref_fab_wb"
    min_wb_area_sqkm: 0.2
    max_distance_m: 1000.0
  osm:
    path: "source_files/osm_dams_all.gpkg"
    layer: "osm_dams_all"
    filter_col: "waterway"
    filter_val: "dam"
  dem:
    path: "source_files/USGS_Seamless_DEM_13.vrt"
    prefer_crs_of_dem: True
    band: 1
    nodata: null
  rules:
    max_waterbody_nearest_dist_m: 1000.0
    min_area_sqkm: 0.2

gages:
  gages:
    inputs:
      usgs_discontinued:
        dir: "usgs_gages_discontinued"
        gage_source_crs: "EPSG:4326"
        id_col_name: "site_no"
      usgs_active:
        dir: "usgs_active_gages"
        id_col_name: "site_no"
      txdot_gages:
        path: "TXDOT_gages/TXDOT_gages.txt"
        gage_source_crs: "EPSG:4326"
        id_col_name: "site_no"
      CADWR_ENVCA:
        path: "CADWR_ENVCA/gage_xy.csv"
        gage_source_crs: "EPSG:4326"
        id_col_name: "site_no"
        x_col_name: "lon"
        y_col_name: "lat"
      nwm_calib_gages:
        path: "nwm_calib/nwm_calib_gages_07112025.csv"
        gage_source_crs: "EPSG:4326"
        id_col_name: "site_no"
    target:
      crs: "EPSG:5070"
      snap_tolerance_m: 100.0
      update_existing: True
      exclude_ids: ["15056210", "15493000"]
      out_gpkg: "gages/gages.gpkg"
      gpkg_layer_name: "gages"

  ###--------------------------------------------
  ## A file for USGS upstream area and basins' shapefiles
  ###--------------------------------------------
  NLDI_upstream_basins:
    run_NLDI_upstream_basins: False
    path: "nldi_upstream_basins.gpkg"
    layer_polys: "NLDI_upstream_basins"
    layer_points: "sites"

  ###--------------------------------------------
  ##SNAPING FLOWPATHS TO GAGES based on upstream catchments area
  ###--------------------------------------------
  assign_fp_to_gages:
   rel_err: 0.25                    # relative acceptable error between total upstream area and USGS upstream area.
   buffer_m: 500.0                 # Buffering around point gages to find flowpaths. in meters
   parallel: False                  # serial (False) or parallel (True)
   max_workers: null                  # None: if serial
   USGS_NLDI_crs: "EPSG:4326"      # usgs crs used in NLDI API. more info: https://waterdata.usgs.gov/blog/nldi-intro/
   work_crs: "EPSG:5070"           # an area-equal crs to calculate buffers and distances

# --------------------------------------------------
# flowpath crosswalk (fp_crosswalk)
# --------------------------------------------------
fp_crosswalk:
  # reference (file1) – usually hydrofabric reference flowpaths
  reference:
    id_col: "flowpath_id"                     # id1_col in code

  # target network (file2) – e.g., NWM or NHDPlus
  target:
    path: "data/reference/nwm_flows.gpkg"               # <- file2
    layer: "nwm_streams"                      # layer2 in code
    id_col: "ID"                              # id2_col in code

  # geometric / matching parameters
  search_radius_m: 10.0       # buffer radius around each reference flowline
  percent_inside_min: 0.005    # min pct of matched path inside band for single-candidate shortcut

  outputs:
    # final full-table crosswalk output
    path: "data/fp_crosswalk_matches.parquet"
